#!/bin/bash

# Load configuration
CONFIG_FILE="./config.properties"

if [ ! -f "$CONFIG_FILE" ]; then
  echo "Configuration file $CONFIG_FILE not found. Exiting."
  exit 1
fi

source "$CONFIG_FILE"

# Validate variables
if [ -z "$SOURCE_PATH" ] || [ -z "$TARGET_PATH_1" ] || [ -z "$TARGET_PATH_2" ]; then
  echo "Missing configuration variables. Exiting."
  exit 1
fi

# Check if RBSCC folders exist in the source path
RBSCC_FOLDERS=($(find "$SOURCE_PATH" -maxdepth 1 -type d -name "RBSCC*"))

if [ ${#RBSCC_FOLDERS[@]} -eq 0 ]; then
  echo "No RBSCC folders found in the source path. Skipping file transfer."
  exit 1
fi

echo "Found RBSCC folders: ${RBSCC_FOLDERS[*]}"
echo "Proceeding with file transfer..."

TARGET_PATHS=($TARGET_PATH_1 $TARGET_PATH_2)

for TARGET_PATH in "${TARGET_PATHS[@]}"; do
  echo "Transferring RBSCC folders to $TARGET_PATH..."

  sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r "${RBSCC_FOLDERS[@]}" user@remote-server:"$TARGET_PATH"
  
  if [ $? -eq 0 ]; then
    echo "Files successfully transferred to $TARGET_PATH"
  else
    echo "Failed to transfer files to $TARGET_PATH"
    exit 1
  fi
done

# Cleanup transferred RBSCC folders
rm -rf "${RBSCC_FOLDERS[@]}"
if [ $? -eq 0 ]; then
  echo "RBSCC folders cleaned up successfully."
else
  echo "Failed to clean up RBSCC folders."
  exit 1
fi
