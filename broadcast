import java.time.LocalTime

def sendMissedAlertEmails(): Unit = {
  val currentHour = LocalTime.now().getHour

import java.time.LocalTime
import org.apache.spark.sql.functions._
import org.apache.spark.sql.SparkSession

// Initialize Spark Session
val spark = SparkSession.builder().appName("MissedAlertsProcessing").getOrCreate()
import spark.implicits._

// ðŸ”¹ Sample missed alerts DataFrame (Replace this with actual missedAlertsDF)
val missedAlertsDF = Seq(
  ("A1", "D"),  // Daily Alert
  ("A2", "W"),  // Weekly Alert
  ("A3", "M"),  // Monthly Alert
  ("A4", "D"),  // Another Daily Alert
  ("A5", "W")   // Another Weekly Alert
).toDF("alert_code", "frequency") 

// âœ… Filter Daily Alerts (D)
val dailyAlertsDF = missedAlertsDF.filter(col("frequency") === "D")

// âœ… Filter Weekly (W) and Monthly (M) Alerts
val weeklyMonthlyAlertsDF = missedAlertsDF.filter(col("frequency").isin("W", "M"))

// âœ… Function to send emails
def sendMissedAlertEmails(alertsDF: org.apache.spark.sql.DataFrame, alertType: String): Unit = {
  alertsDF.collect().foreach { row =>
    val alertCode = row.getString(0)
    val frequency = row.getString(1)
    
    val subject = s"ðŸš¨ Missed Alert Notification: $alertCode ($frequency)"
    val emailBody = s"""
      |The alert <b style="color:red;">$alertCode</b> (Frequency: $frequency) was expected but did not arrive.
      |<p>Could you please check and confirm?</p>
      """.stripMargin

    // Replace with actual email-sending function
    println(s"ðŸ“§ Sending missed alert email for [$alertCode] with frequency [$frequency]")
    // sendEmail(emailAddress, subject, emailBody, "")
  }
}

// âœ… Get current hour dynamically
val currentHour = LocalTime.now().getHour

// âœ… Send emails based on time conditions
if (currentHour == 13

  // Identify missed alerts based on frequency
  val missedDailyAlerts = missedAlerts.filter(alertCode => alertFrequencyMap.getOrElse(alertCode, "m") == "d")
  val missedOtherAlerts = missedAlerts.filter(alertCode => Set("w", "m").contains(alertFrequencyMap.getOrElse(alertCode, "m")))

  if (currentHour == 13 && missedDailyAlerts.nonEmpty) {
    missedDailyAlerts.foreach { alertCode =>
      businessContactsMap.get(alertCode) match {
        case Some((business, emailAddress)) if emailAddress.nonEmpty =>
          val subject = s"ðŸ”´ Missed Daily Alert Notification: $alertCode"
          val emailBody =
            s"""
            |<p>The daily alert <b style="color:red;">$alertCode</b> was scheduled for today but did not arrive.</p>
            |<p>Could you please check and confirm if this is expected?</p>
            |<p>Business Unit: <b>$business</b></p>
            |<p>Cutoff Time: <b>1:00 PM AEST</b></p>
            """.stripMargin

          sendEmail(emailAddress, subject, emailBody, "")
          println(s"Sent missed daily alert email to $emailAddress for alert code: $alertCode")

        case _ =>
          println(s"Warning: No email found for alert code: $alertCode")
      }
    }
  } else if (currentHour == 16 && missedOtherAlerts.nonEmpty) {
    missedOtherAlerts.foreach { alertCode =>
      businessContactsMap.get(alertCode) match {
        case Some((business, emailAddress)) if emailAddress.nonEmpty =>
          val subject = s"ðŸ”´ Missed Weekly/Monthly Alert Notification: $alertCode"
          val emailBody =
            s"""
            |<p>The alert <b style="color:red;">$alertCode</b> was scheduled for today but did not arrive.</p>
            |<p>Could you please check and confirm if this is expected?</p>
            |<p>Business Unit: <b>$business</b></p>
            |<p>Cutoff Time: <b>4:00 PM AEST</b></p>
            """.stripMargin

          sendEmail(emailAddress, subject, emailBody, "")
          println(s"Sent missed weekly/monthly alert email to $emailAddress for alert code: $alertCode")

        case _ =>
          println(s"Warning: No email found for alert code: $alertCode")
      }
    }
  } else {
    println(s"No missed alerts to send at this hour: $currentHour AEST")
  }
}

// Call the function to check and send missed alerts
sendMissedAlertEmails()
