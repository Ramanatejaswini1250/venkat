val expectedAlerts = if (currentHourAEST == 13) { // 1 PM AEST
    df2.filter(col("frequency") === "d")
} else if (currentHourAEST == 16) { // 4 PM AEST
    df2.filter(col("frequency") === "w" && col("run_days_dates") === todayNumber)
       .union(df2.filter(col("frequency") === "m" && col("run_days_dates") === todaydayMonth))
} else {
    spark.emptyDataFrame
}

val expectedAlertsDF = expectedAlerts
    .select("alert_code")
    .distinct()
    .withColumn("alert_code", col("alert_code").cast(StringType))

expectedAlertsDF.show()




// Collect business contacts before processing starts
val businessContactsMap = df
  .select("alert_code", "business", "email_address")
  .distinct()
  .collect()
  .map(row => (row.getString(0), (row.getString(1), row.getString(2))))
  .toMap // Convert to Map for quick lookup


if (missedAlerts.nonEmpty) {
  missedAlerts.foreach { alertCode =>
    businessContactsMap.get(alertCode) match {
      case Some((business, emailAddress)) =>
        val subject = s"ðŸ”´ Missed Alert Notification: $alertCode"
        val emailBody = s"""
        |The alert <b>$alertCode</b> was scheduled for today but did not arrive by the 4:00 PM AEST cutoff.
        |Could you please check and confirm if it is expected?
        """.stripMargin

        sendEmail(emailAddress, subject, emailBody, "T")
        println(s"Sent missed alert email to $emailAddress for alert code: $alertCode")

      case None =>
        println(s"No business contact found for alert code: $alertCode")
    }
  }
}
