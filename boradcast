import org.apache.spark.broadcast.Broadcast
import java.util.Properties

// Broadcasting the properties (not the connection itself)
val connectionProperties = new Properties()
connectionProperties.setProperty("url", "jdbc:mysql://localhost:3306/db")
connectionProperties.setProperty("username", "user")
connectionProperties.setProperty("password", "password")

val broadcastProperties: Broadcast[Properties] = sc.broadcast(connectionProperties)

// Inside the foreachPartition block
df.foreachPartition { partition =>
  val connProps = broadcastProperties.value
  val conn_rss = DriverManager.getConnection(connProps.getProperty("url"),
                                              connProps.getProperty("username"),
                                              connProps.getProperty("password"))

  partition.foreach { row =>
    val stmt_rss = conn_rss.prepareStatement("INSERT INTO my_table (column1, column2) VALUES (?, ?)")
    stmt_rss.setString(1, row.getAs[String]("column1"))
    stmt_rss.setInt(2, row.getAs[Int]("column2"))
    stmt_rss.executeUpdate()
  }

  conn_rss.close()
}
